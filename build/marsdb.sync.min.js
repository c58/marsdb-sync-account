!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(n.Mars||(n.Mars={})).Account=e()}}(function(){return function e(n,t,o){function r(u,a){if(!t[u]){if(!n[u]){var l="function"==typeof require&&require;if(!a&&l)return l(u,!0);if(i)return i(u,!0);var s=new Error("Cannot find module '"+u+"'");throw s.code="MODULE_NOT_FOUND",s}var c=t[u]={exports:{}};n[u][0].call(c.exports,function(e){var t=n[u][1][e];return r(t?t:e)},c,c.exports,e,n,t,o)}return t[u].exports}for(var i="function"==typeof require&&require,u=0;u<o.length;u++)r(o[u]);return r}({1:[function(e,n,t){"use strict";function o(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function r(e){return e&&e.__esModule?e:{"default":e}}function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function u(e){return{algorithm:"sha-256",digest:(0,s["default"])(e)}}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();t._createPasswordObject=u;var l=e("js-sha256"),s=r(l),c=e("marsdb-sync-client"),f=o(c),d=(e("../common/ErrorCodes"),"undefined"!=typeof localStorage||null),h="auth.login.token",p="auth.login.id",g=function(){function e(){var n=this;i(this,e),this._unsetLoginData=function(){d&&(localStorage.removeItem(h),localStorage.removeItem(p))},this._handleLoginResponse=function(e){var n=e.userId,t=e.token;return d&&(localStorage.setItem(h,t),localStorage.setItem(p,n)),n},this._handleLoginError=function(e){throw n._unsetLoginData(),e}}return a(e,[{key:"login",value:function(e,n){var t=u(n);return f.call("/auth/basic/login",e,t).then(this._handleLoginResponse,this._handleLoginError)}},{key:"logout",value:function(){f.call("/auth/basic/logout"),this._unsetLoginData()}},{key:"register",value:function(e,n){var t=u(n);return f.call("/auth/basic/register",e,t).then(this._handleLoginResponse,this._handleLoginError)}},{key:"restoreLogin",value:function(){var e=this;return Promise.resolve().then(function(){var n=e._getRestoreLoginToken();if(n)return f.apply("/auth/token/login",[n],{retryOnDisconnect:!0});throw new Error("No login tokek found")}).then(this._handleLoginResponse,this._handleLoginError)}},{key:"getSavedUserId",value:function(){return d&&localStorage.getItem(p)}},{key:"_getRestoreLoginToken",value:function(){return d&&localStorage.getItem(h)}}]),e}();t["default"]=g},{"../common/ErrorCodes":4,"js-sha256":6,"marsdb-sync-client":void 0}],2:[function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function r(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function u(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function a(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(e,n){var t=[],o=!0,r=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(o=(u=a.next()).done)&&(t.push(u.value),!n||t.length!==n);o=!0);}catch(l){r=!0,i=l}finally{try{!o&&a["return"]&&a["return"]()}finally{if(r)throw i}}return t}return function(n,t){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return e(n,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),c=e("marsdb"),f=e("marsdb-sync-client"),d=r(f),h=e("./BasicLoginClient"),p=o(h),g="/auth/oauth",w="undefined"!=typeof window&&!!window.cordova,v="undefined"!=typeof localStorage,y={};"undefined"!=typeof window&&(window.__handleCredentialSecret=function(e,n){y[e]=n});var _=function(e){function n(){return i(this,n),u(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),s(n,[{key:"login",value:function(e){var n=this,t=c.Random["default"]().id(),o=g+"/popup/"+e+"/"+t;return new Promise(function(e,r){n._showPopup(o,function(){var o=y[t]||v&&localStorage.getItem(t);o?(delete y[t],v&&localStorage.removeItem(t),d.call(g+"/secret/login",t,o).then(n._handleLoginResponse,r).then(e)):r(new Error("No secret for given credential token"))})}).then(null,this._handleLoginError)}},{key:"loginWithToken",value:function(e,n){return d.call(g+"/token/login",e,n).then(this._handleLoginResponse,this._handleLoginError)}},{key:"_handleCredentialSecret",value:function(e,n){y[e]=n}},{key:"_showPopup",value:function(e,n){throw new Error("Not implemented")}}]),n}(p["default"]),m=function(e){function n(){return i(this,n),u(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),s(n,[{key:"_showPopup",value:function(e,n,t){var o=this,r=this._openCenteredPopup(e,t&&t.width||650,t&&t.height||331),i=function(e){var n=e.data.split(":"),t=l(n,2),r=t[0],i=t[1];r&&i&&o._handleCredentialSecret(r,i)},u=setInterval(function(){var e=void 0;try{e=r.closed||void 0===r.closed}catch(t){return}e&&(window.removeEventListener("message",i),clearInterval(u),n())},100);window.addEventListener("message",i,!1)}},{key:"_openCenteredPopup",value:function(e,n,t){var o="undefined"!=typeof window.screenX?window.screenX:window.screenLeft,r="undefined"!=typeof window.screenY?window.screenY:window.screenTop,i="undefined"!=typeof window.outerWidth?window.outerWidth:document.body.clientWidth,u="undefined"!=typeof window.outerHeight?window.outerHeight:document.body.clientHeight-22,a=o+(i-n)/2,l=r+(u-t)/2,s="width="+n+",height="+t+",left="+a+",top="+l+",scrollbars=yes",c=window.open(e,"Login",s);if("undefined"==typeof c){var f=new Error("The login popup was blocked by the browser");throw f.attemptedUrl=e,f}return c.focus&&c.focus(),c}}]),n}(_),b=function(e){function n(){return i(this,n),u(this,Object.getPrototypeOf(n).apply(this,arguments))}return a(n,e),s(n,[{key:"_showPopup",value:function(e,n,t){var o=this,r=function(e){n(new Error("Error from OAuth popup: "+JSON.stringify(e)))},i=!1,u=function s(e){if(!i&&e.url.indexOf("_oauth")>=0){var t=e.url.split("#"),r=t[1];if(!r)return void setTimeout(s,100);var u=JSON.parse(decodeURIComponent(r));o._handleCredentialSecret(u.credentialToken,u.credentialSecret),i=!0,setTimeout(function(){l.close(),n()},100)}},a=function c(){l.removeEventListener("loadstop",u),l.removeEventListener("loaderror",r),l.removeEventListener("exit",c),i||n(new Error("Login canceled"))},l=window.open(e,"_blank","location=yes,hidden=yes,clearcache=yes,clearsessioncache=yes");l.addEventListener("loadstop",u),l.addEventListener("loaderror",r),l.addEventListener("exit",a),l.show()}}]),n}(_);t["default"]=w?b:m},{"./BasicLoginClient":1,marsdb:void 0,"marsdb-sync-client":void 0}],3:[function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e){return E.emit("change",e),e}function u(e){throw E.emit("change",null),e}function a(){arguments.length<=0||void 0===arguments[0]?{}:arguments[0];m.addManager(O),b=new y["default"],L=new w["default"],E=new _,c()}function l(e){var n=e.find({_id:b.getSavedUserId()});return E.on("change",function(e){n.find({_id:e}),n.update()}),n}function s(){b.logout(),i(null)}function c(){return b.restoreLogin().then(i,u)}function f(e,n){return b.login(e,n).then(i,u)}function d(e,n){return b.register(e,n).then(i,u)}function h(e){return L.login(e).then(i,u)}function p(e,n){return L.loginWithToken(e,n).then(i,u)}Object.defineProperty(t,"__esModule",{value:!0}),t._handleSuccessLogin=i,t._handleFailLogin=u,t.configure=a,t.currentUser=l,t.logout=s,t.restoreLogin=c,t.loginBasic=f,t.register=d,t.loginOAuth=h,t.loginOAuthToken=p;var g=e("./OAuthLoginClient"),w=o(g),v=e("./BasicLoginClient"),y=o(v),_="undefined"!=typeof window&&window.Mars?window.Mars.EventEmitter:e("marsdb").EventEmitter,m="undefined"!=typeof window&&window.Mars?window.Mars.Meteor:e("marsdb-sync-client"),b=null,L=null,E=null,O=function S(e){r(this,S),e.on("status:connected",function(e){e&&c()})}},{"./BasicLoginClient":1,"./OAuthLoginClient":2,marsdb:void 0,"marsdb-sync-client":void 0}],4:[function(e,n,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.BASIC_LOGIN_ERR={WRONG_PASS:"WRONG_PASS",WRONG_EMAIL:"WRONG_EMAIL",INVALID_EMAIL:"INVALID_EMAIL",INVALID_PASS:"INVALID_PASS",USED_EMAIL:"USED_EMAIL"}},{}],5:[function(e,n,t){n.exports=e("./dist/client")},{"./dist/client":3}],6:[function(e,n,t){(function(e){!function(t,o){"use strict";var r="undefined"!=typeof n;r&&(t=e);var i=("undefined"!=typeof Uint8Array,"0123456789abcdef".split("")),u=[-2147483648,8388608,32768,128],a=[24,16,8,0],l=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],s=[],c=function(e){return f(e,!0)},f=function(e,n){var o="string"!=typeof e;o&&e.constructor==t.ArrayBuffer&&(e=new Uint8Array(e));var r,c,f,d,h,p,g,w,v,y,_,m,b,L,E,O,S,I,k,A,P,M,C=!0,j=!1,T=0,R=0,N=0,x=e.length;n?(r=3238371032,c=914150663,f=812702999,d=4144912697,h=4290775857,p=1750603025,g=1694076839,w=3204075428):(r=1779033703,c=3144134277,f=1013904242,d=2773480762,h=1359893119,p=2600822924,g=528734635,w=1541459225),v=0;do{if(s[0]=v,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0,o)for(_=R;x>T&&64>_;++T)s[_>>2]|=e[T]<<a[3&_++];else for(_=R;x>T&&64>_;++T)y=e.charCodeAt(T),128>y?s[_>>2]|=y<<a[3&_++]:2048>y?(s[_>>2]|=(192|y>>6)<<a[3&_++],s[_>>2]|=(128|63&y)<<a[3&_++]):55296>y||y>=57344?(s[_>>2]|=(224|y>>12)<<a[3&_++],s[_>>2]|=(128|y>>6&63)<<a[3&_++],s[_>>2]|=(128|63&y)<<a[3&_++]):(y=65536+((1023&y)<<10|1023&e.charCodeAt(++T)),s[_>>2]|=(240|y>>18)<<a[3&_++],s[_>>2]|=(128|y>>12&63)<<a[3&_++],s[_>>2]|=(128|y>>6&63)<<a[3&_++],s[_>>2]|=(128|63&y)<<a[3&_++]);N+=_-R,R=_-64,T==x&&(s[_>>2]|=u[3&_],++T),v=s[16],T>x&&56>_&&(s[15]=N<<3,j=!0);var D=r,U=c,W=f,B=d,G=h,q=p,H=g,V=w;for(m=16;64>m;++m)O=s[m-15],b=(O>>>7|O<<25)^(O>>>18|O<<14)^O>>>3,O=s[m-2],L=(O>>>17|O<<15)^(O>>>19|O<<13)^O>>>10,s[m]=s[m-16]+b+s[m-7]+L<<0;for(M=U&W,m=0;64>m;m+=4)C?(n?(k=300032,O=s[0]-1413257819,V=O-150054599<<0,B=O+24177077<<0):(k=704751109,O=s[0]-210244248,V=O-1521486534<<0,B=O+143694565<<0),C=!1):(b=(D>>>2|D<<30)^(D>>>13|D<<19)^(D>>>22|D<<10),L=(G>>>6|G<<26)^(G>>>11|G<<21)^(G>>>25|G<<7),k=D&U,E=k^D&W^M,I=G&q^~G&H,O=V+L+I+l[m]+s[m],S=b+E,V=B+O<<0,B=O+S<<0),b=(B>>>2|B<<30)^(B>>>13|B<<19)^(B>>>22|B<<10),L=(V>>>6|V<<26)^(V>>>11|V<<21)^(V>>>25|V<<7),A=B&D,E=A^B&U^k,I=V&G^~V&q,O=H+L+I+l[m+1]+s[m+1],S=b+E,H=W+O<<0,W=O+S<<0,b=(W>>>2|W<<30)^(W>>>13|W<<19)^(W>>>22|W<<10),L=(H>>>6|H<<26)^(H>>>11|H<<21)^(H>>>25|H<<7),P=W&B,E=P^W&D^A,I=H&V^~H&G,O=q+L+I+l[m+2]+s[m+2],S=b+E,q=U+O<<0,U=O+S<<0,b=(U>>>2|U<<30)^(U>>>13|U<<19)^(U>>>22|U<<10),L=(q>>>6|q<<26)^(q>>>11|q<<21)^(q>>>25|q<<7),M=U&W,E=M^U&B^P,I=q&H^~q&V,O=G+L+I+l[m+3]+s[m+3],S=b+E,G=D+O<<0,D=O+S<<0;r=r+D<<0,c=c+U<<0,f=f+W<<0,d=d+B<<0,h=h+G<<0,p=p+q<<0,g=g+H<<0,w=w+V<<0}while(!j);var J=i[r>>28&15]+i[r>>24&15]+i[r>>20&15]+i[r>>16&15]+i[r>>12&15]+i[r>>8&15]+i[r>>4&15]+i[15&r]+i[c>>28&15]+i[c>>24&15]+i[c>>20&15]+i[c>>16&15]+i[c>>12&15]+i[c>>8&15]+i[c>>4&15]+i[15&c]+i[f>>28&15]+i[f>>24&15]+i[f>>20&15]+i[f>>16&15]+i[f>>12&15]+i[f>>8&15]+i[f>>4&15]+i[15&f]+i[d>>28&15]+i[d>>24&15]+i[d>>20&15]+i[d>>16&15]+i[d>>12&15]+i[d>>8&15]+i[d>>4&15]+i[15&d]+i[h>>28&15]+i[h>>24&15]+i[h>>20&15]+i[h>>16&15]+i[h>>12&15]+i[h>>8&15]+i[h>>4&15]+i[15&h]+i[p>>28&15]+i[p>>24&15]+i[p>>20&15]+i[p>>16&15]+i[p>>12&15]+i[p>>8&15]+i[p>>4&15]+i[15&p]+i[g>>28&15]+i[g>>24&15]+i[g>>20&15]+i[g>>16&15]+i[g>>12&15]+i[g>>8&15]+i[g>>4&15]+i[15&g];return n||(J+=i[w>>28&15]+i[w>>24&15]+i[w>>20&15]+i[w>>16&15]+i[w>>12&15]+i[w>>8&15]+i[w>>4&15]+i[15&w]),J};!t.JS_SHA256_TEST&&r?(f.sha256=f,f.sha224=c,n.exports=f):t&&(t.sha256=f,t.sha224=c)}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[5])(5)});